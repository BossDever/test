<?php
// Seed surveys, sections, questions, and an admin user.
require_once __DIR__ . '/../../app/config/config.php';

function up(PDO $pdo){
    // Ensure roles exist (idempotent)
    $roles = [1=>'admin',2=>'teacher',3=>'committee',4=>'expert'];
    foreach ($roles as $id=>$name){
        $pdo->prepare('INSERT IGNORE INTO roles (id,name) VALUES (?,?)')->execute([$id,$name]);
    }

    // Create admin user if not exists
    $username = 'admin';
    $exists = $pdo->prepare('SELECT id FROM users WHERE username=?');
    $exists->execute([$username]);
    if (!$exists->fetch()){
        $hash = password_hash('Admin@1234', PASSWORD_DEFAULT);
        $pdo->prepare('INSERT INTO users (username,password_hash,role_id,display_name) VALUES (?,?,1,?)')
            ->execute([$username,$hash,'ผู้ดูแลระบบ']);
        audit_log($pdo, (int)$pdo->lastInsertId(), 'seed', 'Created default admin');
    }

    // Insert survey
    $pdo->prepare('INSERT INTO surveys (title, description, is_active, created_by) VALUES (?,?,1, (SELECT id FROM users WHERE username=?))')
        ->execute(['แบบประเมินคุณภาพรายวิชา','แบบประเมินแบ่ง 3 หมวด Likert 1-5 พร้อมข้อเสนอแนะ','admin']);
    $surveyId = (int)$pdo->lastInsertId();

    // Sections
    $sections = [
        ['code'=>'1','title'=>'หมวด 1: เนื้อหา', 'order'=>1],
        ['code'=>'2','title'=>'หมวด 2: วิธีการสอน', 'order'=>2],
        ['code'=>'3','title'=>'หมวด 3: การประเมินผล', 'order'=>3],
    ];
    $secId = [];
    foreach ($sections as $s){
        $pdo->prepare('INSERT INTO sections (survey_id, code, title, sort_order) VALUES (?,?,?,?)')
            ->execute([$surveyId, $s['code'], $s['title'], $s['order']]);
        $secId[$s['code']] = (int)$pdo->lastInsertId();
    }

    // Questions content (Thai) as provided
    $q = [];
    // หมวด 1: เนื้อหา (1.1 – 1.6)
    $q[]=['1.1','มีควำมครอบคลุม สอดคล้อง กับค ำอธิบำยรำยวิชำ'];
    $q[]=['1.2','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนคุณธรรมจริยธรรม'];
    $q[]=['1.3','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนควำมรู้'];
    $q[]=['1.4','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะทำงปัญญำ'];
    $q[]=['1.5','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะควำมสัมพันธ์ระหว่ำงบุคคลและควำมรับผิดชอบ'];
    $q[]=['1.6','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะกำรวิเครำะห์เชิงตัวเลข กำรสื่อสำร และกำรใช้เทคโนโลยี สำรสนเทศ'];

    // หมวด 2: วิธีการสอน (2.1 – 2.5)
    $q[]=['2.1','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนคุณธรรมจริยธรรม'];
    $q[]=['2.2','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนควำมรู้'];
    $q[]=['2.3','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะทำงปัญญำ'];
    $q[]=['2.4','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะควำมสัมพันธ์ระหว่ำงบุคคลและควำมรับผิดชอบ'];
    $q[]=['2.5','มีควำมสอดคล้องเหมำะสมกับมำตรฐำนผลกำรเรียนรู้ ด้ำนทักษะกำรวิเครำะห์เชิงตัวเลข กำรสื่อสำร และกำรใช้เทคโนโลยี สำรสนเทศ'];

    // หมวด 3: การประเมินผล (3.1 – 3.7 + subitems)
    $q[]=['3.1(1)','กำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำ 1) ด้ำนคุณธรรมจริยธรรม'];
    $q[]=['3.1(2)','กำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำ 2) ด้ำนควำมรู้'];
    $q[]=['3.1(3)','กำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำ 3) ด้ำนทักษะทำงปัญญำ'];
    $q[]=['3.1(4)','กำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำ 4) ด้ำนทักษะควำมสัมพันธ์ระหว่ำงบุคคลและควำมรับผิดชอบ'];
    $q[]=['3.1(5)','กำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำ 5) ด้ำนทักษะกำรวิเครำะห์เชิงตัวเลข กำรสื่อสำร และกำรใช้เทคโนโลยี สำรสนเทศ'];

    $q[]=['3.2(1)','มีกำรใช้วิธีกำรวัดและประเมินผลกำรเรียนรู้ที่หลำกหลำย 1) กำรสังเกตพฤติกรรม'];
    $q[]=['3.2(2)','2) กำรประเมินผลงำน/รำยงำน/กำรน ำเสนอผลงำน'];
    $q[]=['3.2(3)','3) กำรสอบถำม/กำรสัมภำษณ์'];
    $q[]=['3.2(4)','4) กำรทดสอบ'];
    $q[]=['3.2(5)','5) อื่นๆ (โปรดระบุ)'];

    $q[]=['3.3(1)','มีกำรประเมินผลกำรเรียนรู้ของนิสิตนักศึกษำอย่ำงต่อเนื่อง 1) ก่อนจัดกำรเรียนกำรสอน'];
    $q[]=['3.3(2)','2) ระหว่างจัดกำรเรียนกำรสอน'];
    $q[]=['3.3(3)','3) หลังสิ้นสุดจัดกำรเรียนกำรสอน'];

    $q[]=['3.4','มีคะแนนผลสัมฤทธิ์ที่ได้จำกคะแนนเก็บและคะแนนสอบ'];
    $q[]=['3.5','กำรวัดและประเมินผลสอดคล้องเหมำะสมกับกิจกรรม กำรเรียนกำรสอน'];
    $q[]=['3.6','มีกำรวัดและประเมินผลเป็นไปตำมแผนกำรประเมินผล (สัปดำห์ที่จะประเมิน) กับกำรด ำเนินกำรจริง'];
    $q[]=['3.7','เครื่องมือวัดและประเมินผล และผลงาน'];

    $insQ = $pdo->prepare('INSERT INTO questions (survey_id, section_id, item_code, q_text, q_type, is_required, has_detail, sort_order) VALUES (?,?,?,?,?,?,?,?)');
    $order = 0;
    foreach ($q as $row){
        $code = $row[0]; $text = $row[1];
        $secCode = substr($code,0,1);
        $sid = $secId[$secCode] ?? null;
        if (!$sid) continue;
        $type = 'likert';
        $hasDetail = (strpos($code,'3.2(5)')===0) ? 1 : 0; // allow detail for "อื่นๆ"
        $insQ->execute([$surveyId, $sid, $code, $text, $type, 1, $hasDetail, ++$order]);
    }

    echo "Seed completed. Survey ID: $surveyId\n";
}

up($pdo);
